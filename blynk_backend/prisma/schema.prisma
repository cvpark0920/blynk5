generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                             String                   @id @default(cuid())
  email                          String                   @unique
  passwordHash                   String?                  @map("password_hash")
  role                           UserRole                 @default(CUSTOMER)
  createdAt                      DateTime                 @default(now()) @map("created_at")
  updatedAt                      DateTime                 @updatedAt @map("updated_at")
  avatarUrl                      String?                  @map("avatar_url")
  name                           String?
  chatReadStatuses               ChatReadStatus[]
  deviceRegistrationCodesCreated DeviceRegistrationCode[]
  ownedRestaurants               Restaurant[]             @relation("RestaurantOwner")

  @@map("users")
}

model Restaurant {
  id                      String                   @id @default(cuid())
  nameKo                  String                   @map("name_ko")
  nameVn                  String                   @map("name_vn")
  nameEn                  String?                  @map("name_en")
  ownerId                 String                   @map("owner_id")
  qrCode                  String                   @unique @map("qr_code")
  status                  String                   @default("active")
  settings                Json?                    @default("{}")
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")
  subdomain               String?                  @unique @map("subdomain")
  chatReadStatuses        ChatReadStatus[]
  deviceRegistrationCodes DeviceRegistrationCode[]
  deviceTokens            DeviceToken[]
  categories              MenuCategory[]
  notifications           Notification[]
  orders                  Order[]
  promotions              Promotion[]
  quickChips              QuickChip[]
  pushSubscriptions       PushSubscription[]
  owner                   User                     @relation("RestaurantOwner", fields: [ownerId], references: [id])
  sessions                Session[]
  staff                   Staff[]
  tables                  Table[]
  waitingList             WaitingList[]

  @@index([subdomain])
  @@map("restaurants")
}

model Table {
  id               String      @id @default(cuid())
  restaurantId     String      @map("restaurant_id")
  tableNumber      Int         @map("table_number")
  floor            Int         @default(1)
  capacity         Int         @default(4)
  qrCode           String      @unique @map("qr_code")
  status           TableStatus @default(EMPTY)
  currentSessionId String?     @map("current_session_id")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  isActive         Boolean     @default(true) @map("is_active")
  orders           Order[]
  sessions         Session[]
  restaurant       Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([qrCode])
  @@map("tables")
}

model Session {
  id               String           @id @default(cuid())
  tableId          String           @map("table_id")
  restaurantId     String           @map("restaurant_id")
  status           SessionStatus    @default(ACTIVE)
  guestCount       Int              @default(1) @map("guest_count")
  startedAt        DateTime         @default(now()) @map("started_at")
  endedAt          DateTime?        @map("ended_at")
  chatMessages     ChatMessage[]
  chatReadStatuses ChatReadStatus[]
  orders           Order[]
  restaurant       Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table            Table            @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@index([restaurantId])
  @@index([status])
  @@map("sessions")
}

model MenuCategory {
  id           String     @id @default(cuid())
  restaurantId String     @map("restaurant_id")
  nameKo       String     @map("name_ko")
  nameVn       String     @map("name_vn")
  nameEn       String?    @map("name_en")
  nameZh       String?    @map("name_zh")
  nameRu       String?    @map("name_ru")
  displayOrder Int        @default(0) @map("display_order")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems    MenuItem[]

  @@index([restaurantId])
  @@map("menu_categories")
}

model MenuItem {
  id            String            @id @default(cuid())
  categoryId    String            @map("category_id")
  restaurantId  String            @map("restaurant_id")
  nameKo        String            @map("name_ko")
  nameVn        String            @map("name_vn")
  nameEn        String?           @map("name_en")
  nameZh        String?           @map("name_zh")
  nameRu        String?           @map("name_ru")
  descriptionKo String?           @map("description_ko")
  descriptionVn String?           @map("description_vn")
  descriptionEn String?           @map("description_en")
  descriptionZh String?           @map("description_zh")
  descriptionRu String?           @map("description_ru")
  priceVnd      Int               @map("price_vnd")
  imageUrl      String?           @map("image_url")
  isSoldOut     Boolean           @default(false) @map("is_sold_out")
  displayOrder  Int               @default(0) @map("display_order")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  category      MenuCategory      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  optionGroups  MenuOptionGroup[]
  orderItems    OrderItem[]
  promotionMenuItems PromotionMenuItem[]

  @@index([categoryId])
  @@index([restaurantId])
  @@map("menu_items")
}

model MenuOptionGroup {
  id         String       @id @default(cuid())
  menuItemId String       @map("menu_item_id")
  nameKo     String       @map("name_ko")
  nameVn     String       @map("name_vn")
  nameEn     String?      @map("name_en")
  nameZh     String?      @map("name_zh")
  nameRu     String?      @map("name_ru")
  minSelect  Int          @default(0) @map("min_select")
  maxSelect  Int          @default(1) @map("max_select")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")
  menuItem   MenuItem     @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  options    MenuOption[]

  @@index([menuItemId])
  @@map("menu_option_groups")
}

model MenuOption {
  id               String            @id @default(cuid())
  optionGroupId    String            @map("option_group_id")
  nameKo           String            @map("name_ko")
  nameVn           String            @map("name_vn")
  nameEn           String?           @map("name_en")
  nameZh           String?           @map("name_zh")
  nameRu           String?           @map("name_ru")
  priceVnd         Int               @default(0) @map("price_vnd")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  optionGroup      MenuOptionGroup   @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)
  orderItemOptions OrderItemOption[]

  @@index([optionGroupId])
  @@map("menu_options")
}

model Order {
  id           String      @id @default(cuid())
  sessionId    String      @map("session_id")
  tableId      String      @map("table_id")
  restaurantId String      @map("restaurant_id")
  status       OrderStatus @default(PENDING)
  totalAmount  Int         @map("total_amount")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  items        OrderItem[]
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  session      Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  table        Table       @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([tableId])
  @@index([restaurantId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id         String            @id @default(cuid())
  orderId    String            @map("order_id")
  menuItemId String            @map("menu_item_id")
  quantity   Int               @default(1)
  unitPrice  Int               @map("unit_price")
  totalPrice Int               @map("total_price")
  notes      Json?             @default("[]")
  createdAt  DateTime          @default(now()) @map("created_at")
  options    OrderItemOption[]
  menuItem   MenuItem          @relation(fields: [menuItemId], references: [id])
  order      Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_items")
}

model OrderItemOption {
  id          String     @id @default(cuid())
  orderItemId String     @map("order_item_id")
  optionId    String     @map("option_id")
  quantity    Int        @default(1)
  price       Int        @default(0)
  createdAt   DateTime   @default(now()) @map("created_at")
  option      MenuOption @relation(fields: [optionId], references: [id])
  orderItem   OrderItem  @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@map("order_item_options")
}

model ChatMessage {
  id               String      @id @default(cuid())
  sessionId        String      @map("session_id")
  senderType       SenderType  @map("sender_type")
  textKo           String?     @map("text_ko")
  textVn           String?     @map("text_vn")
  textEn           String?     @map("text_en")
  textZh           String?     @map("text_zh")
  textRu           String?     @map("text_ru")
  messageType      MessageType @map("message_type")
  imageUrl         String?     @map("image_url")
  metadata         Json?       @default("{}")
  createdAt        DateTime    @default(now()) @map("created_at")
  detectedLanguage String?     @map("detected_language")
  session          Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_messages")
}

model ChatReadStatus {
  id                String     @id @default(cuid())
  userId            String     @map("user_id")
  staffId           String?    @map("staff_id")
  sessionId         String     @map("session_id")
  restaurantId      String     @map("restaurant_id")
  lastReadMessageId String     @map("last_read_message_id")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")
  restaurant        Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  session           Session    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  staff             Staff?     @relation(fields: [staffId], references: [id], onDelete: Cascade)
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId])
  @@index([restaurantId])
  @@index([sessionId])
  @@index([staffId])
  @@map("chat_read_status")
}

model Staff {
  id                      String                   @id @default(cuid())
  restaurantId            String                   @map("restaurant_id")
  name                    String
  email                   String?
  role                    StaffRole                @default(STAFF)
  status                  StaffStatus              @default(PENDING)
  phone                   String?
  avatarUrl               String?                  @map("avatar_url")
  joinedAt                DateTime                 @default(now()) @map("joined_at")
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")
  deviceId                String?                  @map("device_id")
  isDevice                Boolean                  @default(false) @map("is_device")
  chatReadStatuses        ChatReadStatus[]
  deviceRegistrationCodes DeviceRegistrationCode[]
  deviceTokens            DeviceToken[]
  pushSubscriptions       PushSubscription[]
  restaurant              Restaurant               @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([email])
  @@index([status])
  @@index([deviceId])
  @@map("staff")
}

model DeviceRegistrationCode {
  id              String     @id @default(cuid())
  restaurantId    String     @map("restaurant_id")
  code            String     @unique
  role            StaffRole
  label           String?
  expiresAt       DateTime   @map("expires_at")
  usedAt          DateTime?  @map("used_at")
  usedByDeviceId  String?    @map("used_by_device_id")
  createdByUserId String     @map("created_by_user_id")
  createdAt       DateTime   @default(now()) @map("created_at")
  staffId         String     @map("staff_id")
  createdBy       User       @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  staff           Staff      @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([staffId])
  @@index([expiresAt])
  @@map("device_registration_codes")
}

model DeviceToken {
  id           String     @id @default(cuid())
  restaurantId String     @map("restaurant_id")
  staffId      String     @map("staff_id")
  deviceId     String     @map("device_id")
  tokenHash    String     @map("token_hash")
  label        String?
  issuedAt     DateTime   @default(now()) @map("issued_at")
  lastUsedAt   DateTime?  @map("last_used_at")
  revokedAt    DateTime?  @map("revoked_at")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  staff        Staff      @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, deviceId])
  @@index([restaurantId])
  @@index([staffId])
  @@map("device_tokens")
}

model WaitingList {
  id           String        @id @default(cuid())
  restaurantId String        @map("restaurant_id")
  name         String
  phone        String
  guestCount   Int           @default(1) @map("guest_count")
  status       WaitingStatus @default(WAITING)
  note         String?
  timestamp    DateTime      @default(now())
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([status])
  @@index([timestamp])
  @@map("waiting_list")
}

model RestaurantCategory {
  id           String   @id @default(cuid())
  nameKo       String   @unique @map("name_ko")
  nameVn       String   @map("name_vn")
  nameEn       String?  @map("name_en")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([displayOrder])
  @@map("restaurant_categories")
}

model RestaurantRegion {
  id           String   @id @default(cuid())
  nameKo       String   @unique @map("name_ko")
  nameVn       String   @map("name_vn")
  nameEn       String?  @map("name_en")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([displayOrder])
  @@map("restaurant_regions")
}

model Notification {
  id            String           @id @default(cuid())
  restaurantId  String           @map("restaurant_id")
  type          NotificationType
  titleKo       String?          @map("title_ko")
  titleVn       String?          @map("title_vn")
  titleEn       String?          @map("title_en")
  descriptionKo String?          @map("description_ko")
  descriptionVn String?          @map("description_vn")
  descriptionEn String?          @map("description_en")
  metadata      Json?            @default("{}")
  isRead        Boolean          @default(false) @map("is_read")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  restaurant    Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Bank {
  id                Int      @id @default(autoincrement())
  name              String   @map("name")
  code              String   @unique @map("code")
  bin               String   @map("bin")
  shortName         String   @map("short_name")
  logo              String?  @map("logo")
  transferSupported Boolean  @default(true) @map("transfer_supported")
  lookupSupported   Boolean  @default(true) @map("lookup_supported")
  swiftCode         String?  @map("swift_code")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([code])
  @@index([shortName])
  @@map("banks")
}

model QuickChip {
  id           String        @id @default(cuid())
  restaurantId String?       @map("restaurant_id")
  type         QuickChipType
  icon         String
  labelKo      String        @map("label_ko")
  labelVn      String        @map("label_vn")
  labelEn      String?       @map("label_en")
  labelZh      String?       @map("label_zh")
  labelRu      String?       @map("label_ru")
  messageKo    String?       @map("message_ko")
  messageVn    String?       @map("message_vn")
  messageEn    String?       @map("message_en")
  messageZh    String?       @map("message_zh")
  messageRu    String?       @map("message_ru")
  displayOrder Int           @default(0) @map("display_order")
  isActive     Boolean       @default(true) @map("is_active")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  templateKey  String?       @map("template_key")
  restaurant   Restaurant?   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([type])
  @@index([displayOrder])
  @@map("quick_chips")
}

model Promotion {
  id              String     @id @default(cuid())
  restaurantId    String     @map("restaurant_id")
  titleKo         String     @map("title_ko")
  titleVn         String     @map("title_vn")
  titleEn         String?    @map("title_en")
  titleZh         String?    @map("title_zh")
  titleRu         String?    @map("title_ru")
  descriptionKo   String?    @map("description_ko")
  descriptionVn   String?    @map("description_vn")
  descriptionEn   String?    @map("description_en")
  descriptionZh   String?    @map("description_zh")
  descriptionRu   String?    @map("description_ru")
  imageUrl        String?    @map("image_url")
  discountPercent Int?       @map("discount_percent")
  startDate       DateTime   @map("start_date")
  endDate         DateTime   @map("end_date")
  displayOrder    Int        @default(0) @map("display_order")
  isActive        Boolean    @default(true) @map("is_active")
  showOnLoad      Boolean    @default(false) @map("show_on_load")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  promotionMenuItems PromotionMenuItem[]

  @@index([restaurantId])
  @@index([startDate, endDate])
  @@index([isActive])
  @@map("promotions")
}

model PromotionMenuItem {
  id          String     @id @default(cuid())
  promotionId String     @map("promotion_id")
  menuItemId  String     @map("menu_item_id")
  createdAt   DateTime   @default(now()) @map("created_at")
  promotion   Promotion  @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  menuItem    MenuItem   @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@unique([promotionId, menuItemId])
  @@index([promotionId])
  @@index([menuItemId])
  @@map("promotion_menu_items")
}

model PushSubscription {
  id           String    @id @default(cuid())
  restaurantId String    @map("restaurant_id")
  staffId      String?   @map("staff_id")
  endpoint     String    @unique
  p256dh       String
  auth         String
  userAgent    String?   @map("user_agent")
  lastSeenAt   DateTime  @default(now()) @map("last_seen_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  staff        Staff?    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([staffId])
  @@index([endpoint])
  @@map("push_subscriptions")
}

enum UserRole {
  CUSTOMER
  ADMIN
  PLATFORM_ADMIN
}

enum TableStatus {
  EMPTY
  ORDERING
  DINING
  CLEANING
}

enum SessionStatus {
  ACTIVE
  ENDED
  CANCELLED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  COOKING
  SERVED
  DELIVERED
  CANCELLED
  PAID
}

enum StaffRole {
  OWNER
  MANAGER
  STAFF
  KITCHEN
  HALL
}

enum StaffStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum WaitingStatus {
  WAITING
  NOTIFIED
  SEATED
  CANCELLED
}

enum MessageType {
  TEXT
  ORDER
  REQUEST
  IMAGE
}

enum SenderType {
  USER
  STAFF
  SYSTEM
}

enum NotificationType {
  ORDER_NEW
  ORDER_STATUS_CHANGED
  CHAT_NEW
  PAYMENT_CONFIRMED
  WATER_REQUEST
  SHIFT_ALERT
  CUSTOMER_REQUEST
}

enum QuickChipType {
  CUSTOMER_REQUEST
  STAFF_RESPONSE
}
